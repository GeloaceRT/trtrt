---

 - name: Add GPG key for the Prometheus repository (Ubuntu)
      apt_key:
        url: https://packages.grafana.com/gpg.key
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Add Prometheus APT repository (Ubuntu)
      apt_repository:
        repo: deb https://packages.grafana.com/oss/deb stable main
        state: present
        filename: grafana
      when: ansible_distribution == "Ubuntu"

    - name: Install Prometheus (Ubuntu)
      apt:
        name: prometheus
        state: present
      when: ansible_distribution == "Ubuntu"

    - name: Enable and start Prometheus service (Ubuntu)
      service:
        name: prometheus
        enabled: yes
        state: started
      when: ansible_distribution == "Ubuntu"

    - name: Open port 9090 for Prometheus (Ubuntu)
      ufw:
        rule: allow
        port: 9090
        proto: tcp
        state: enabled
      when: ansible_distribution == "Ubuntu"

    - name: Download and extract Prometheus (CentOS)
      unarchive:
        src: https://github.com/prometheus/prometheus/releases/download/v2.48.1/prometheus-2.48.1.linux-amd64.tar.gz
        dest: /usr/local/bin
        remote_src: yes
        mode: '0755'
        owner: root
        group: root
      when: ansible_distribution == "CentOS"

    - name: Copy Prometheus binaries to /usr/local/bin
      copy:
        src: "/usr/local/bin/prometheus-2.48.1.linux-amd64/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
      loop:
        - prometheus
        - promtool
      when: ansible_distribution == "CentOS"

    - name: Create Prometheus directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /etc/prometheus
        - /var/lib/prometheus
      when: ansible_distribution == "CentOS"

    - name: Move configuration files to /etc/prometheus
      copy:
        src: "/usr/local/bin/prometheus-2.48.1.linux-amd64/{{ item }}"
        dest: "/etc/prometheus/{{ item }}"
        remote_src: yes
      loop:
        - prometheus.yml
        - consoles
        - console_libraries
      when: ansible_distribution == "CentOS"

    - name: Create Prometheus service file (CentOS)
      template:
        src: prometheus.service.j2
        dest: /etc/systemd/system/prometheus.service
      when: ansible_distribution == "CentOS"

    - name: Reload systemd (CentOS)
      command: systemctl daemon-reload
      when: ansible_distribution == "CentOS"

    - name: Start Prometheus service (CentOS)
      service:
        name: prometheus
        enabled: yes
        state: started
      when: ansible_distribution == "CentOS"

    - name: Open Firewall Port for Prometheus (CentOS)
      firewalld:
        port: 9090/tcp
        permanent: yes
        state: enabled
      when: ansible_distribution == "CentOS"

    - name: Enable Prometheus on system boot (CentOS)
      service:
        name: prometheus
        enabled: yes
      when: ansible_distribution == "CentOS"
